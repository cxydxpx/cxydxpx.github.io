---
title: 配置构建
date: 2017-10-31 17:40:02
tags:
author: mushanYun
---

# APK混淆

<!--more-->

### 代码混淆规则

* 普通java类一定被混淆（无论是类名 方法名或变量）

* AndroidManifest.xml注册过的四大组件，都不会被混淆

* 只要一个类中有native方法，这个native方法不会被混淆

  ​

### 混淆规则 Proguard-android.txt

* `-dont use mixed case class names` 表示混淆时不使用大小写混合类名。 

* `-dont skip non public library classes` 表示不跳过library中的非public的类。 

* `-verbose` 表示打印混淆的详细信息。 

* `-dont optimize` 表示不进行优化，建议使用此选项，因为根据proguard-android-optimize.txt中的描述，优化可能会造成一些潜在风险，不能保证在所有版本的Dalvik上都正常运行。 

* `-don't preverify` 表示不进行预校验。这个预校验是作用在Java平台上的，Android平台上不需要这项功能，去掉之后还可以加快混淆速度。

* `-keep attributes *Annotation*` 表示对注解中的参数进行保留。

* 表示不混淆上述声明的两个类，这两个类我们基本也用不上，是接入Google原生的一些服务时使用的。

  ```
  -keep public class com.google.vending.licensing.ILicensingService

  -keep public class com.android.vending.licensing.ILicensingService
  ```

  ​

* 表示不混淆任何包含native方法的类的类名以及native方法名

  ```
  -keep classes with member names class * {
      native <methods>;
  }
  ```

  ​

* 表示不混淆任何一个View中的setXxx()和getXxx()方法，因为属性动画需要有相应的setter和getter的方法实现，混淆了就无法工作了。

  ```
  -keep class members public class * extends android.view.View {
     void set*(***);
     *** get*();
  }
  ```

* 表示不混淆Activity中参数是View的方法，因为有这样一种用法，在XML中配置android:onClick=”buttonClick”属性，当用户点击该按钮时就会调用Activity中的buttonClick(View view)方法，如果这个方法被混淆的话就找不到了。

  ```
  -keep class members class * extends android.app.Activity {
     public void *(android.view.View);
  }
  ```

  ​

* 表示不混淆枚举中的values()和valueOf()方法 

  ```
  -keep class members enum * {
      public static **[] values();
      public static ** valueOf(java.lang.String);
  }
  ```

  ​

* 表示不混淆Parcelable实现类中的CREATOR字段，毫无疑问，CREATOR字段是绝对不能改变的，包括大小写都不能变，不然整个Parcelable工作机制都会失败。

  ```
  -keep class members class * implements android.os.Parcelable {
    public static final android.os.Parcelable$Creator CREATOR;
  }
  ```

  ​

* 表示不混淆R文件中的所有静态字段，我们都知道R文件是通过字段来记录每个资源的id的，字段名要是被混淆了，id也就找不着了。 

  ```
  -keep classmembers class **.R$* {
      public static <fields>;
  }
  ```

  ​

* `dontwarn android.support.**` 表示对android.support包下的代码不警告，因为support包中有很多代码都是在高版本中使用的，如果我们的项目指定的版本比较低在打包时就会给予警告。不过support包中所有的代码都在版本兼容性上做足了判断，因此不用担心代码会出问题，所以直接忽略警告就可以了。 

### 关键字

|            关键字             |                    描述                    |
| :------------------------: | :--------------------------------------: |
|            keep            |          保留类和类中的成员，防止它们被混淆或被移除           |
|         keepnames          |     保留类和类中的成员，防止它们被混淆，但当成员没有被引用时会被移除     |
|      keepclassmembers      |           只保留了类中的成员，防止它们被混淆或移除           |
|   keepclasseswithmembers   |     只保留类中的成员，防止它们被混淆，但当成员没有被引用时会被移除      |
| keppclasseswithmembernames | 保留类和类中的成员，防止它们被混淆，但当成员没有被引用时会被移除，前提是指明的类中的成员必须存在，如果不存在则还是会 |



### 通配符

|  通配符   |                    描述                    |
| :----: | :--------------------------------------: |
| field  |                匹配类中的所有字段                 |
| method |                匹配类中的所有方法                 |
|  init  |               匹配类中的所有构造函数                |
|   *    | 匹配任意长度字符，但不含包名分隔符(.)。比如说我们的完整类名是com.example.test.MyActivity，使用com.*，或者com.exmaple.*都是无法匹配的，因为*无法匹配包名中的分隔符，正确的匹配方式是com.exmaple.*.*，或者com.exmaple.test.*，这些都是可以的。但如果你不写任何其它内容，只有一个*，那就表示匹配所有的东西。 |
|   **   | 匹配任意长度字符，并且包含包名分隔符(.)。比如proguard-android.txt中使用的-dontwarn android.support.**就可以匹配android.support包下的所有内容，包括任意长度的子包。 |
|  ***   | 匹配任意参数类型。比如void set*(***)就能匹配任意传入的参数类型，*** get*()就能匹配任意返回值的类型。 |
|  ...   | 匹配任意长度的任意类型参数。比如void test(…)就能匹配任意void test(String a)或者是void test(int a, String b)这些方法。 |

### Proguard官网

* [https://www.guardsquare.com/en/proguard](https://www.guardsquare.com/en/proguard)
* [http://developer.android.com/guide/developing/tools/proguard.html](http://developer.android.com/guide/developing/tools/proguard.html)
* [郭霖文档](http://blog.csdn.net/guolin_blog/article/details/50451259)

